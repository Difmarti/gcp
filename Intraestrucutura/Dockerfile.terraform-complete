# Usar Ubuntu 22.04 como imagen base
FROM ubuntu:22.04

# Establecer variables de entorno para evitar prompts interactivos
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONUNBUFFERED=1 \
    PATH="/opt/act_runner:/opt/terraform:${PATH}"

# Actualizar el sistema e instalar dependencias b√°sicas
RUN apt-get update && apt-get upgrade -y && \
    apt-get install -y \
    curl \
    wget \
    git \
    ca-certificates \
    gnupg \
    lsb-release \
    apt-transport-https \
    software-properties-common \
    docker.io \
    python3 \
    python3-pip \
    python3-dev \
    build-essential \
    jq \
    unzip \
    zip \
    vim \
    nano \
    sudo \
    && rm -rf /var/lib/apt/lists/*

# Instalar Google Cloud SDK
RUN echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | \
    tee -a /etc/apt/sources.list.d/google-cloud-sdk.list && \
    curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | \
    apt-key --keyring /usr/share/keyrings/cloud.google.gpg add - && \
    apt-get update && apt-get install -y google-cloud-sdk && \
    rm -rf /var/lib/apt/lists/*

# Instalar Terraform
RUN mkdir -p /opt/terraform && \
    cd /tmp && \
    wget https://releases.hashicorp.com/terraform/1.6.4/terraform_1.6.4_linux_amd64.zip && \
    unzip terraform_1.6.4_linux_amd64.zip -d /opt/terraform && \
    rm terraform_1.6.4_linux_amd64.zip && \
    chmod +x /opt/terraform/terraform && \
    /opt/terraform/terraform --version

# Instalar TFLint (Terraform Linter)
RUN echo "Installing TFLint..." && \
    cd /tmp && \
    curl -s https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | bash && \
    rm -rf /tmp/tflint* && \
    tflint --version

# Instalar Checkov (Security Scanner)
RUN echo "Installing Checkov..." && \
    pip3 install --upgrade pip setuptools wheel && \
    pip3 install checkov && \
    checkov --version

# Instalar herramientas adicionales para validaci√≥n
RUN pip3 install \
    pyyaml \
    jsonschema \
    yamllint \
    && echo "Validation tools installed"

# Crear directorio para Act Runner
RUN mkdir -p /opt/act_runner /data/act_runner && \
    chmod 755 /opt/act_runner /data/act_runner

# Descargar el binario de Act Runner versi√≥n 0.2.13
RUN wget https://dl.gitea.com/act_runner/0.2.13/act_runner-0.2.13-linux-amd64 \
    -O /opt/act_runner/act_runner && \
    chmod +x /opt/act_runner/act_runner

# Crear script de entrada para configurar Act Runner
RUN cat > /opt/act_runner/entrypoint.sh << 'EOF'
#!/bin/bash
set -e

# Mostrar informaci√≥n de las herramientas instaladas
echo "========================================="
echo "üöÄ Act Runner con Terraform CI/CD"
echo "========================================="
echo ""
echo "üì¶ Herramientas Instaladas:"
echo "---"
echo "Terraform: $(terraform --version | head -1)"
echo "TFLint: $(tflint --version)"
echo "Checkov: $(checkov --version | head -1)"
echo "Google Cloud SDK: $(gcloud --version | head -1)"
echo "Python: $(python3 --version)"
echo "Docker: $(docker --version 2>/dev/null || echo 'Socket not available')"
echo "---"
echo ""

# Variables de entorno que pueden ser pasadas al contenedor
GITEA_INSTANCE_URL=${GITEA_INSTANCE_URL:-http://localhost:3000}
GITEA_RUNNER_REGISTRATION_TOKEN=${GITEA_RUNNER_REGISTRATION_TOKEN:-}
RUNNER_NAME=${RUNNER_NAME:-$(hostname)}
RUNNER_LABELS=${RUNNER_LABELS:-ubuntu-latest:docker://gitea/runner-images:ubuntu-latest,terraform:docker://gitea/runner-images:ubuntu-latest}

# Comprobar si el directorio de configuraci√≥n ya existe
if [ ! -f /data/act_runner/.registered ]; then
    if [ -z "$GITEA_RUNNER_REGISTRATION_TOKEN" ]; then
        echo "ERROR: GITEA_RUNNER_REGISTRATION_TOKEN no est√° configurado"
        echo "Por favor, establece la variable de entorno GITEA_RUNNER_REGISTRATION_TOKEN"
        exit 1
    fi
    
    echo "Registrando Act Runner..."
    /opt/act_runner/act_runner register \
        --instance "$GITEA_INSTANCE_URL" \
        --token "$GITEA_RUNNER_REGISTRATION_TOKEN" \
        --name "$RUNNER_NAME" \
        --labels "$RUNNER_LABELS" \
        --no-interactive
    
    touch /data/act_runner/.registered
    echo "‚úÖ Act Runner registrado exitosamente"
else
    echo "‚ÑπÔ∏è Act Runner ya est√° registrado"
fi

echo ""
echo "========================================="
echo "Iniciando Act Runner daemon..."
echo "========================================="
echo ""

# Ejecutar el daemon
exec /opt/act_runner/act_runner daemon
EOF

RUN chmod +x /opt/act_runner/entrypoint.sh

# Crear script de verificaci√≥n de herramientas
RUN cat > /usr/local/bin/check-tools.sh << 'EOF'
#!/bin/bash
echo "========================================="
echo "üìã Verificaci√≥n de Herramientas"
echo "========================================="
echo ""

echo "‚úÖ Terraform:"
terraform --version
echo ""

echo "‚úÖ TFLint:"
tflint --version
echo ""

echo "‚úÖ Checkov:"
checkov --version
echo ""

echo "‚úÖ Google Cloud SDK:"
gcloud --version | head -3
echo ""

echo "‚úÖ Python:"
python3 --version
echo ""

echo "‚úÖ Git:"
git --version
echo ""

echo "‚úÖ Docker:"
docker --version 2>/dev/null || echo "Docker Socket not available"
echo ""

echo "========================================="
echo "Todas las herramientas est√°n disponibles ‚úÖ"
echo "========================================="
EOF

RUN chmod +x /usr/local/bin/check-tools.sh

# Crear script para validar Terraform
RUN cat > /usr/local/bin/validate-tf.sh << 'EOF'
#!/bin/bash
set -e

if [ $# -eq 0 ]; then
    echo "Uso: validate-tf.sh <directorio>"
    exit 1
fi

TERRAFORM_DIR=$1

echo "========================================="
echo "üîç Validando Terraform en: $TERRAFORM_DIR"
echo "========================================="
echo ""

cd "$TERRAFORM_DIR"

# 1. Validar formato
echo "1Ô∏è‚É£ Validando formato..."
terraform fmt -check -recursive . && echo "‚úÖ Formato correcto" || echo "‚ùå Formato incorrecto"

# 2. Validar sintaxis
echo ""
echo "2Ô∏è‚É£ Validando sintaxis..."
terraform init -backend=false > /dev/null 2>&1
terraform validate && echo "‚úÖ Sintaxis correcta" || echo "‚ùå Sintaxis incorrecta"

# 3. Ejecutar TFLint
echo ""
echo "3Ô∏è‚É£ Ejecutando TFLint..."
tflint . && echo "‚úÖ TFLint sin issues" || echo "‚ö†Ô∏è TFLint encontr√≥ warnings"

# 4. Ejecutar Checkov
echo ""
echo "4Ô∏è‚É£ Ejecutando Checkov..."
checkov -d . --framework terraform --soft-fail && echo "‚úÖ Checkov completado" || echo "‚ö†Ô∏è Checkov encontr√≥ issues"

echo ""
echo "========================================="
echo "‚úÖ Validaci√≥n completada"
echo "========================================="
EOF

RUN chmod +x /usr/local/bin/validate-tf.sh

# Verificar que todas las herramientas est√©n disponibles en el PATH
RUN echo "=========================================" && \
    echo "Verificando herramientas instaladas..." && \
    echo "=========================================" && \
    which terraform && terraform --version && \
    which tflint && tflint --version && \
    which checkov && checkov --version && \
    which gcloud && gcloud --version | head -1 && \
    echo "=========================================" && \
    echo "‚úÖ Todas las herramientas est√°n disponibles" && \
    echo "========================================="

# Crear directorio de trabajo
WORKDIR /data/act_runner

# Informaci√≥n de la imagen
LABEL version="1.0" \
      description="Act Runner con Terraform, TFLint, Checkov y Google Cloud SDK" \
      author="Cloud Architecture Team" \
      tools="terraform:1.6.4,tflint:latest,checkov:latest,gcloud:latest,docker.io"

# Punto de entrada
ENTRYPOINT ["/opt/act_runner/entrypoint.sh"]